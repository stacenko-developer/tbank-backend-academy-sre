# Описание решения

В качестве решения использования Sidecar паттерн - основной контейнер **mysql** и дополнительный контейнер **mysql-exporter** работают в одном поде. 

> **mysql-exporter** - это официальный экспортер Prometheus для MySQL

```
- name: mysql-exporter
  image: prom/mysqld-exporter:v0.15.1
  args:
    - "--config.my-cnf=/etc/mysql-exporter/my.cnf"
    - "--collect.engine_innodb_status"
    - "--collect.global_variables"
    - "--collect.global_status"
    - "--collect.info_schema.innodb_metrics"
    - "--collect.info_schema.processlist"
    - "--collect.info_schema.tables"
  volumeMounts:
    - name: mysql-exporter-config
      mountPath: /etc/mysql-exporter
      readOnly: true
   ports:
    - name: metrics
      containerPort: 9104
```
Активированы следующие коллекторы для сбора метрик:
- engine_innodb_status (внутренние параметры работы InnoDB: статус InnoDB Engine информация о блокировках, состояние транзакций и т.д.)
- global_variables (глобальные переменные)
- global_status (статистика состояния сервера)
- innodb_metrics (метрики из таблицы innodb_metrics)
- processlist (список процессов)
- tables (статистика по таблицам) 

mysql-exporter-configmap содержит данные для подключения к MySQL. mysql-exporter предоставляет метрики в формате Prometheus на порту 9104.
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-exporter-configmap
  namespace: st-ab5-statsenko
data:
  my.cnf: |
    [client]
    user = root
    password = 1234
    host = 127.0.0.1
    port = 3306

``` 
По условию задания в кластере уже развернут компонент vmagent, обеспечивающий сбор метрик.
Для настройки таргета для сбора метрик указаны следующие аннотации:
- prometheus.io/scrape
- prometheus.io/port
- prometheus.io/path
Итоговый вариант Service:
```
apiVersion: v1
kind: Service
metadata:
  name: oncall-mysql
  namespace: st-ab5-statsenko
  labels:
    app: mysql
    app.kubernetes.io/name: mysql
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9104"
    prometheus.io/path: /metrics
spec:
  ports:
    - name: mysql
      protocol: TCP
      port: 3306
    - name: mysql-exporter
      protocol: TCP
      port: 9104
  clusterIP: None
  selector:
    app: mysql
```